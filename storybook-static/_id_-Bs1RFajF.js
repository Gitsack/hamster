import{j as e}from"./jsx-runtime-u17CrQMm.js";import{f as Z,t as o,r as f,H as p,L as S}from"./app-CFoDCqX-.js";import{A as j,D as ee,a as se,b as te,c as ae}from"./app-layout-CTvh2ZE0.js";import{B as n}from"./button-B9kPMW4q.js";import{B as oe}from"./badge-B6bn15vN.js";import{C as T,d as $}from"./card-BT9UEfea.js";import{S as h}from"./skeleton-A7behTLO.js";import{D as q,a as I,b as O,c as E,d as L,e as M}from"./dialog-CQTA4pg1.js";import{H as r,z as g,D as re,F as le,G as ie,q as z,n as ne,A as de,J as ce}from"./index.min-fvaCWwiU.js";import{S as v}from"./spinner-McTJFRVv.js";import{r as i}from"./app-BHuVDAkc.js";import{a2 as me,a6 as he}from"./media-status-badge-DETbNkVM.js";import"./preload-helper-PPVm8Dsz.js";import"./client-Bx265bNG.js";import"./index-CYxWbFTv.js";import"./index-D5-0xbEa.js";import"./utils-CDN07tui.js";import"./media-teaser-CTZEtwns.js";import"./check-BEKQ83Eb.js";import"./createLucideIcon-GXN1tXoc.js";import"./useRenderElement-D0Q1kVud.js";import"./useLabelableId-CyGgmgle.js";import"./useBaseUiId-BvJSLVy2.js";import"./useValueAsRef-GoV-SdOe.js";import"./valueToPercent-CmxdyyhM.js";import"./slot-CUYGZ4Fv.js";import"./hamster-icon-DOXrnfMg.js";import"./input-Bw95PIWX.js";function ue(){const{url:A}=Z(),d=A.split("/").pop(),[s,c]=i.useState(null),[H,R]=i.useState(!0),[P,m]=i.useState(!1),[U,u]=i.useState(!1),[w,N]=i.useState(!1),[b,k]=i.useState(!1),[F,y]=i.useState(!1),[_,D]=i.useState(!1),[J,B]=i.useState(null);i.useEffect(()=>{G(),C();const t=setInterval(C,5e3);return()=>clearInterval(t)},[d]);const G=async()=>{try{const t=await fetch(`/api/v1/books/${d}`);if(t.ok){const a=await t.json();c(a)}else t.status===404&&(o.error("Book not found"),f.visit("/library?tab=books"))}catch(t){console.error("Failed to fetch book:",t),o.error("Failed to load book")}finally{R(!1)}},C=async()=>{try{const t=await fetch("/api/v1/queue");if(t.ok){const l=(await t.json()).find(x=>x.bookId===d);B(l?{progress:l.progress||0,status:l.status||"downloading"}:null)}}catch{}},K=()=>s?he(s,J):{status:"none",progress:0},W=async()=>{if(!s)return;const t=s.requested;if(t&&s.hasFile){m(!0);return}c({...s,requested:!t}),D(!0);try{const a=await fetch(`/api/v1/books/${d}/request`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({requested:!t})}),l=await a.json();a.ok?l.deleted?(o.success("Removed from library"),f.visit("/library?tab=books")):o.success(t?"Book unrequested":"Book requested"):l.hasFile?(c({...s,requested:t}),m(!0)):(c({...s,requested:t}),o.error(l.error||"Failed to update book"))}catch(a){console.error("Failed to update book:",a),c({...s,requested:t}),o.error("Failed to update book")}finally{D(!1)}},Q=async(t=!1)=>{N(!0);try{const a=t?`/api/v1/books/${d}?deleteFile=true`:`/api/v1/books/${d}`,l=await fetch(a,{method:"DELETE"});if(l.ok)o.success(t?"Book and files deleted":"Book deleted"),f.visit("/library?tab=books");else{const x=await l.json();o.error(x.error||"Failed to delete")}}catch(a){console.error("Failed to delete book:",a),o.error("Failed to delete book")}finally{N(!1),m(!1)}},V=async()=>{if(s){y(!0);try{const t=await fetch(`/api/v1/books/${d}/download`,{method:"POST"});if(t.ok){const a=await t.json();o.success(`Download started: ${a.release?.title||s.title}`)}else{const a=await t.json();o.error(a.error||"No releases found")}}catch(t){console.error("Failed to download:",t),o.error("Failed to download book")}finally{y(!1)}}},X=async()=>{if(s){k(!0);try{const t=await fetch(`/api/v1/books/${d}/file`,{method:"DELETE"});if(t.ok)o.success("File deleted successfully"),c({...s,hasFile:!1,bookFile:null});else{const a=await t.json();o.error(a.error||"Failed to delete file")}}catch(t){console.error("Failed to delete file:",t),o.error("Failed to delete file")}finally{k(!1),u(!1)}}},Y=t=>t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`;return H?e.jsxs(j,{title:"Loading...",children:[e.jsx(p,{title:"Loading..."}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"flex gap-6",children:[e.jsx(h,{className:"h-72 w-48 rounded-lg"}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsx(h,{className:"h-8 w-1/3"}),e.jsx(h,{className:"h-4 w-1/4"}),e.jsx(h,{className:"h-4 w-2/3"}),e.jsx(h,{className:"h-4 w-1/2"})]})]})})]}):s?e.jsxs(j,{title:s.title,actions:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(n,{variant:"outline",asChild:!0,children:e.jsxs(S,{href:s.author?`/author/${s.author.id}`:"/library",children:[e.jsx(r,{icon:ne,className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:"Back"})]})}),!s.hasFile&&e.jsxs(n,{onClick:V,disabled:F,children:[F?e.jsx(v,{className:"md:mr-2"}):e.jsx(r,{icon:de,className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:"Search releases"})]}),e.jsxs(ee,{children:[e.jsx(se,{asChild:!0,children:e.jsx(n,{variant:"outline",size:"icon",children:e.jsx(r,{icon:ce,className:"h-4 w-4"})})}),e.jsx(te,{align:"end",children:e.jsxs(ae,{className:"text-destructive",onClick:()=>m(!0),children:[e.jsx(r,{icon:z,className:"h-4 w-4 mr-2"}),"Remove from Library"]})})]})]}),children:[e.jsx(p,{title:s.title}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"w-full md:w-48 aspect-[2/3] md:aspect-auto md:h-72 bg-muted rounded-lg overflow-hidden flex-shrink-0",children:s.coverUrl?e.jsx("img",{src:s.coverUrl,alt:s.title,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(r,{icon:g,className:"h-16 w-16 text-muted-foreground/50"})})}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("h1",{className:"text-2xl font-bold",children:s.title})}),s.author&&e.jsxs(S,{href:`/author/${s.author.id}`,className:"text-muted-foreground hover:text-primary transition-colors flex items-center gap-1",children:[e.jsx(r,{icon:re,className:"h-4 w-4"}),s.author.name]})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:(()=>{const{status:t,progress:a}=K();return e.jsx(me,{status:t,progress:a,isToggling:_,onToggleRequest:W})})()}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-2 text-sm",children:[s.releaseDate&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(r,{icon:le,className:"h-4 w-4"}),s.releaseDate.split("-")[0]]}),s.pageCount&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(r,{icon:g,className:"h-4 w-4"}),s.pageCount," pages"]}),s.publisher&&e.jsx("div",{className:"text-muted-foreground",children:s.publisher})]}),s.seriesName&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Series: "}),e.jsx("span",{children:s.seriesName}),s.seriesPosition&&e.jsxs("span",{className:"text-muted-foreground",children:[" #",s.seriesPosition]})]}),(s.isbn||s.isbn13)&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.isbn13&&e.jsxs("span",{children:["ISBN-13: ",s.isbn13]}),s.isbn13&&s.isbn&&e.jsx("span",{children:" • "}),s.isbn&&e.jsxs("span",{children:["ISBN-10: ",s.isbn]})]}),s.genres&&s.genres.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:s.genres.slice(0,5).map((t,a)=>e.jsx(oe,{variant:"outline",children:t},a))})]})]}),s.overview&&e.jsx(T,{children:e.jsxs($,{className:"pt-6",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Overview"}),e.jsx("p",{className:"text-muted-foreground whitespace-pre-line",children:s.overview})]})}),s.bookFile&&e.jsx(T,{children:e.jsxs($,{className:"pt-6",children:[e.jsx("h2",{className:"font-semibold mb-4",children:"File"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(r,{icon:g,className:"h-8 w-8 text-muted-foreground flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:s.bookFile.path.split("/").pop()}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.bookFile.format&&`${s.bookFile.format.toUpperCase()} • `,Y(s.bookFile.size)]}),e.jsx("p",{className:"text-xs text-muted-foreground/70 truncate",children:s.bookFile.path})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(n,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs("a",{href:s.bookFile.downloadUrl,download:!0,children:[e.jsx(r,{icon:ie,className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Download"})]})}),e.jsxs(n,{variant:"outline",size:"sm",className:"text-destructive hover:text-destructive",onClick:()=>u(!0),children:[e.jsx(r,{icon:z,className:"h-4 w-4 sm:mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Delete"})]})]})]})]})})]}),e.jsx(q,{open:P,onOpenChange:m,children:e.jsxs(I,{children:[e.jsxs(O,{children:[e.jsx(E,{children:s.hasFile?"Remove from library?":`Delete ${s.title}?`}),e.jsx(L,{children:s.hasFile?"This will permanently delete the downloaded files from disk and remove the book from your library.":"This will remove the book from your library."})]}),e.jsxs(M,{children:[e.jsx(n,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),e.jsx(n,{variant:"destructive",onClick:()=>Q(s.hasFile),disabled:w,children:w?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"mr-2"}),"Deleting..."]}):s.hasFile?"Delete Files & Remove":"Delete"})]})]})}),e.jsx(q,{open:U,onOpenChange:u,children:e.jsxs(I,{children:[e.jsxs(O,{children:[e.jsx(E,{children:"Delete book file?"}),e.jsx(L,{children:"This will permanently delete the book file from disk. The book will remain in your library but will need to be downloaded again."})]}),e.jsxs(M,{children:[e.jsx(n,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsx(n,{variant:"destructive",onClick:X,disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx(v,{className:"mr-2"}),"Deleting..."]}):"Delete File"})]})]})})]}):e.jsxs(j,{title:"Not Found",children:[e.jsx(p,{title:"Not Found"}),e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"Book not found"})})]})}ue.__docgenInfo={description:"",methods:[],displayName:"BookDetail"};export{ue as default};
