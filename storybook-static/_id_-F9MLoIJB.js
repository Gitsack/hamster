import{j as e}from"./jsx-runtime-u17CrQMm.js";import{f as ue,t as o,r as se,H as E,L as re}from"./app-CFoDCqX-.js";import{A as H,D as he,a as me,b as ge,c as J,d as pe}from"./app-layout-CTvh2ZE0.js";import{B as p}from"./button-B9kPMW4q.js";import{B as j}from"./badge-B6bn15vN.js";import{C as fe,d as xe}from"./card-BT9UEfea.js";import{S as L}from"./skeleton-A7behTLO.js";import{T as ye,a as je,b as N,c as I}from"./tabs-BOg1k8aW.js";import{D as ve,a as we,b as be,c as Ne,d as Ie,e as qe}from"./dialog-CQTA4pg1.js";import{H as d,z as _,w as ae,n as Fe,$ as Ae,L as ke,J as Se,M as Te,d as De,u as Be,q as Ce,k as Le,m as $e,A as Pe}from"./index.min-fvaCWwiU.js";import{S as A}from"./spinner-McTJFRVv.js";import{r as n}from"./app-BHuVDAkc.js";import"./preload-helper-PPVm8Dsz.js";import"./client-Bx265bNG.js";import"./index-CYxWbFTv.js";import"./index-D5-0xbEa.js";import"./utils-CDN07tui.js";import"./media-status-badge-DETbNkVM.js";import"./useRenderElement-D0Q1kVud.js";import"./useBaseUiId-BvJSLVy2.js";import"./useValueAsRef-GoV-SdOe.js";import"./media-teaser-CTZEtwns.js";import"./check-BEKQ83Eb.js";import"./createLucideIcon-GXN1tXoc.js";import"./useLabelableId-CyGgmgle.js";import"./valueToPercent-CmxdyyhM.js";import"./slot-CUYGZ4Fv.js";import"./hamster-icon-DOXrnfMg.js";import"./input-Bw95PIWX.js";function Me(){const{url:l}=ue(),h=l.split("/").pop(),[r,c]=n.useState(null),[k,$]=n.useState([]),[S,T]=n.useState(!0),[P,f]=n.useState(!1),[x,D]=n.useState(!1),[M,v]=n.useState(!1),[u,g]=n.useState(!1),[m,te]=n.useState(new Map),[B,W]=n.useState(new Set),[V,Y]=n.useState(new Set),[G,K]=n.useState(!1);n.useEffect(()=>{w(),Q();const s=setInterval(Q,5e3);return()=>clearInterval(s)},[h]),n.useEffect(()=>{r?.openlibraryId&&U(r.openlibraryId)},[r?.openlibraryId]);const Q=async()=>{try{const s=await fetch("/api/v1/queue");if(s.ok){const t=await s.json(),a=new Map;for(const i of t)i.bookId&&a.set(i.bookId,{progress:i.progress||0,status:i.status||"downloading"});te(a)}}catch{}},w=async()=>{try{const s=await fetch(`/api/v1/authors/${h}`);if(s.ok){const t=await s.json();c(t)}else s.status===404&&(o.error("Author not found"),se.visit("/library?tab=books"))}catch(s){console.error("Failed to fetch author:",s),o.error("Failed to load author")}finally{T(!1)}},U=async s=>{f(!0);try{const t=await fetch(`/api/v1/authors/${encodeURIComponent(s)}/works`);if(t.ok){const a=await t.json();$(a)}}catch(t){console.error("Failed to fetch bibliography:",t)}finally{f(!1)}},ie=async()=>{D(!0);try{const s=await fetch(`/api/v1/authors/${h}/refresh`,{method:"POST"});if(s.ok){const t=await s.json();o.success(`Author refreshed${t.booksAdded>0?`, ${t.booksAdded} books added`:""}`),w(),r?.openlibraryId&&U(r.openlibraryId)}else{const t=await s.json();o.error(t.error||"Failed to refresh")}}catch(s){console.error("Failed to refresh author:",s),o.error("Failed to refresh author")}finally{D(!1)}},oe=async()=>{if(!r)return;const s=r.monitored;c({...r,monitored:!s});try{(await fetch(`/api/v1/authors/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({monitored:!s})})).ok?o.success(s?"Monitoring disabled":"Monitoring enabled"):(c({...r,monitored:s}),o.error("Failed to update monitoring"))}catch(t){console.error("Failed to update monitoring:",t),c({...r,monitored:s}),o.error("Failed to update monitoring")}},le=async()=>{if(r)try{(await fetch(`/api/v1/authors/${h}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({requested:!r.requested})})).ok&&(c({...r,requested:!r.requested}),o.success(r.requested?"Author unrequested":"Author requested"))}catch(s){console.error("Failed to update author:",s),o.error("Failed to update author")}},ne=async()=>{g(!0);try{const s=await fetch(`/api/v1/authors/${h}`,{method:"DELETE"});if(s.ok)o.success("Author deleted"),se.visit("/library?tab=books");else{const t=await s.json();o.error(t.error||"Failed to delete")}}catch(s){console.error("Failed to delete author:",s),o.error("Failed to delete author")}finally{g(!1),v(!1)}},b=async(s,t)=>{if(r){c({...r,books:r.books.map(a=>a.id===s?{...a,requested:!t}:a)}),W(a=>new Set(a).add(s));try{(await fetch(`/api/v1/books/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({requested:!t})})).ok?o.success(t?"Book unrequested":"Book requested"):(c({...r,books:r.books.map(i=>i.id===s?{...i,requested:t}:i)}),o.error("Failed to update book"))}catch(a){console.error("Failed to update book:",a),c({...r,books:r.books.map(i=>i.id===s?{...i,requested:t}:i)}),o.error("Failed to update book")}finally{W(a=>{const i=new Set(a);return i.delete(s),i})}}},X=async s=>{if(r){Y(t=>new Set(t).add(s.openlibraryId));try{const t=await fetch("/api/v1/books",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({openlibraryId:s.openlibraryId,authorId:String(r.id),title:s.title,rootFolderId:String(r.rootFolder?.id),qualityProfileId:r.qualityProfile?.id?String(r.qualityProfile.id):void 0,requested:!0})});if(t.ok)o.success(`Added "${s.title}" to library`),w(),r.openlibraryId&&U(r.openlibraryId);else{const a=await t.json();o.error(a.error||"Failed to add book")}}catch(t){console.error("Failed to add book:",t),o.error("Failed to add book")}finally{Y(t=>{const a=new Set(t);return a.delete(s.openlibraryId),a})}}},de=async()=>{if(!r)return;const s=r.books.filter(t=>!t.requested&&!t.hasFile);if(s.length===0){o.info("All books are already requested or downloaded");return}c({...r,books:r.books.map(t=>({...t,requested:t.hasFile?t.requested:!0}))}),K(!0);try{const a=(await Promise.all(s.map(i=>fetch(`/api/v1/books/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({requested:!0})})))).filter(i=>!i.ok).length;a===0?o.success(`Requested ${s.length} books`):a<s.length?o.warning(`Requested ${s.length-a} books, ${a} failed`):(o.error("Failed to request books"),w())}catch(t){console.error("Failed to request all books:",t),o.error("Failed to request books"),w()}finally{K(!1)}},y=n.useMemo(()=>{const s=new Map(r?.books.map(a=>[a.id,a])||[]),t=k.map(a=>{const i=a.bookId?s.get(a.bookId):void 0;return{openlibraryId:a.openlibraryId,title:a.title,description:a.description,coverUrl:a.coverUrl||i?.coverUrl,inLibrary:a.inLibrary,libraryId:a.bookId,requested:a.requested||i?.requested||!1,hasFile:a.hasFile||i?.hasFile||!1,seriesName:i?.seriesName,seriesPosition:i?.seriesPosition}});for(const a of r?.books||[])k.find(i=>i.bookId===a.id)||t.push({openlibraryId:"",title:a.title,description:null,coverUrl:a.coverUrl,inLibrary:!0,libraryId:a.id,requested:a.requested,hasFile:a.hasFile,seriesName:a.seriesName,seriesPosition:a.seriesPosition});return t.sort((a,i)=>a.title.localeCompare(i.title))},[r?.books,k]),R=y.filter(s=>s.inLibrary),O=y.filter(s=>s.inLibrary&&s.hasFile),z=y.filter(s=>s.inLibrary&&s.requested&&!s.hasFile),C=y.filter(s=>!s.inLibrary),ce=r?.books.length||0,Z=r?.books.filter(s=>s.hasFile).length||0,ee=r?.books.filter(s=>s.requested&&!s.hasFile).length||0;return S?e.jsxs(H,{title:"Loading...",children:[e.jsx(E,{title:"Loading..."}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"flex gap-6",children:[e.jsx(L,{className:"h-48 w-48 rounded-lg"}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsx(L,{className:"h-8 w-1/3"}),e.jsx(L,{className:"h-4 w-1/2"}),e.jsx(L,{className:"h-4 w-2/3"})]})]})})]}):r?e.jsxs(H,{title:r.name,actions:e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(p,{variant:"outline",asChild:!0,children:e.jsxs(re,{href:"/library?tab=books",children:[e.jsx(d,{icon:Fe,className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:"Back"})]})}),e.jsxs(p,{variant:"outline",size:"sm",onClick:oe,children:[e.jsx(d,{icon:r.monitored?Ae:ke,className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:r.monitored?"Monitored":"Monitor"})]}),e.jsxs(he,{children:[e.jsx(me,{asChild:!0,children:e.jsx(p,{variant:"outline",size:"icon",children:e.jsx(d,{icon:Se,className:"h-4 w-4"})})}),e.jsxs(ge,{align:"end",children:[e.jsxs(J,{onClick:le,children:[e.jsx(d,{icon:r.requested?Te:De,className:"h-4 w-4 mr-2"}),r.requested?"Unrequest":"Request"]}),e.jsxs(J,{onClick:ie,disabled:x,children:[e.jsx(d,{icon:Be,className:`h-4 w-4 mr-2 ${x?"animate-spin":""}`}),"Refresh"]}),e.jsx(pe,{}),e.jsxs(J,{className:"text-destructive",onClick:()=>v(!0),children:[e.jsx(d,{icon:Ce,className:"h-4 w-4 mr-2"}),"Delete"]})]})]})]}),children:[e.jsx(E,{title:r.name}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"w-full md:w-48 aspect-square md:aspect-auto md:h-48 bg-muted rounded-lg overflow-hidden flex-shrink-0",children:r.imageUrl?e.jsx("img",{src:r.imageUrl,alt:r.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(d,{icon:_,className:"h-16 w-16 text-muted-foreground/50"})})}),e.jsxs("div",{className:"flex-1 space-y-4",children:[e.jsx("div",{children:e.jsx("div",{className:"flex items-center gap-2 mb-1",children:e.jsx("h1",{className:"text-2xl font-bold",children:r.name})})}),r.overview&&e.jsx("p",{className:"text-muted-foreground line-clamp-3",children:r.overview}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(j,{variant:"outline",children:[ce," books"]})}),Z>0&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(j,{variant:"default",className:"bg-green-600",children:[Z," downloaded"]})}),ee>0&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(j,{variant:"secondary",children:[ee," requested"]})})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.qualityProfile&&e.jsx(j,{variant:"outline",children:r.qualityProfile.name}),r.rootFolder&&e.jsx(j,{variant:"outline",children:r.rootFolder.path})]})]})]}),e.jsxs(ye,{defaultValue:"all",className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs(je,{className:"flex-wrap h-auto",children:[e.jsxs(N,{value:"all",children:["Bibliography (",y.length,")",P&&e.jsx(A,{className:"ml-2 h-3 w-3"})]}),e.jsxs(N,{value:"library",children:["In Library (",R.length,")"]}),e.jsxs(N,{value:"downloaded",children:["Downloaded (",O.length,")"]}),e.jsxs(N,{value:"requested",children:["Requested (",z.length,")"]}),C.length>0&&e.jsxs(N,{value:"available",children:["Available (",C.length,")"]})]}),r.books.some(s=>!s.requested&&!s.hasFile)&&e.jsx(p,{variant:"outline",size:"sm",onClick:de,disabled:G,children:G?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"mr-2"}),"Requesting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(d,{icon:ae,className:"h-4 w-4 mr-2"}),"Request All in Library"]})})]}),e.jsx(I,{value:"all",className:"space-y-4",children:y.length===0?e.jsx(q,{message:P?"Loading bibliography...":"No books found. Try refreshing to fetch from OpenLibrary."}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:y.map(s=>e.jsx(F,{book:s,downloadInfo:s.libraryId?m.get(s.libraryId):void 0,isToggling:s.libraryId?B.has(s.libraryId):!1,isAdding:V.has(s.openlibraryId),onToggleRequest:b,onAdd:()=>X({openlibraryId:s.openlibraryId,title:s.title,description:s.description,coverUrl:s.coverUrl,subjects:null,inLibrary:s.inLibrary,bookId:s.libraryId||null,requested:s.requested,hasFile:s.hasFile})},s.openlibraryId||s.libraryId))})}),e.jsx(I,{value:"library",className:"space-y-4",children:R.length===0?e.jsx(q,{message:"No books in library yet"}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:R.map(s=>e.jsx(F,{book:s,downloadInfo:s.libraryId?m.get(s.libraryId):void 0,isToggling:s.libraryId?B.has(s.libraryId):!1,isAdding:!1,onToggleRequest:b,onAdd:()=>{}},s.openlibraryId||s.libraryId))})}),e.jsx(I,{value:"downloaded",className:"space-y-4",children:O.length===0?e.jsx(q,{message:"No downloaded books yet"}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:O.map(s=>e.jsx(F,{book:s,downloadInfo:s.libraryId?m.get(s.libraryId):void 0,isToggling:s.libraryId?B.has(s.libraryId):!1,isAdding:!1,onToggleRequest:b,onAdd:()=>{}},s.openlibraryId||s.libraryId))})}),e.jsx(I,{value:"requested",className:"space-y-4",children:z.length===0?e.jsx(q,{message:"No requested books"}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:z.map(s=>e.jsx(F,{book:s,downloadInfo:s.libraryId?m.get(s.libraryId):void 0,isToggling:s.libraryId?B.has(s.libraryId):!1,isAdding:!1,onToggleRequest:b,onAdd:()=>{}},s.openlibraryId||s.libraryId))})}),e.jsx(I,{value:"available",className:"space-y-4",children:C.length===0?e.jsx(q,{message:"All books are in library"}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:C.map(s=>e.jsx(F,{book:s,downloadInfo:void 0,isToggling:!1,isAdding:V.has(s.openlibraryId),onToggleRequest:b,onAdd:()=>X({openlibraryId:s.openlibraryId,title:s.title,description:s.description,coverUrl:s.coverUrl,subjects:null,inLibrary:s.inLibrary,bookId:s.libraryId||null,requested:s.requested,hasFile:s.hasFile})},s.openlibraryId||s.libraryId))})})]})]}),e.jsx(ve,{open:M,onOpenChange:v,children:e.jsxs(we,{children:[e.jsxs(be,{children:[e.jsxs(Ne,{children:["Delete ",r.name,"?"]}),e.jsx(Ie,{children:"This will remove the author and all associated books from your library. Files on disk will not be deleted."})]}),e.jsxs(qe,{children:[e.jsx(p,{variant:"outline",onClick:()=>v(!1),children:"Cancel"}),e.jsx(p,{variant:"destructive",onClick:ne,disabled:u,children:u?e.jsxs(e.Fragment,{children:[e.jsx(A,{}),"Deleting..."]}):"Delete"})]})]})})]}):e.jsxs(H,{title:"Not Found",children:[e.jsx(E,{title:"Not Found"}),e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"Author not found"})})]})}function q({message:l}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[e.jsx("div",{className:"rounded-full bg-muted p-6 mb-4",children:e.jsx(d,{icon:_,className:"h-12 w-12 text-muted-foreground"})}),e.jsx("p",{className:"text-muted-foreground",children:l})]})}function F({book:l,downloadInfo:h,isToggling:r,isAdding:c,onToggleRequest:k,onAdd:$}){const[S,T]=n.useState(!1);l.hasFile||(h?h.status:l.requested);const f=!l.inLibrary,x=l.hasFile,D=u=>{u.preventDefault(),u.stopPropagation(),$()},M=async u=>{if(u.preventDefault(),u.stopPropagation(),!!l.libraryId){T(!0);try{const g=await fetch(`/api/v1/books/${l.libraryId}/download`,{method:"POST"});if(g.ok){const m=await g.json();o.success(`Download started: ${m.release?.title||m.title}`)}else{const m=await g.json();o.error(m.error||"No releases found")}}catch(g){console.error("Failed to download:",g),o.error("Failed to download book")}finally{T(!1)}}},v=l.libraryId?({children:u})=>e.jsx(re,{href:`/book/${l.libraryId}`,children:u}):({children:u})=>e.jsx(e.Fragment,{children:u});return e.jsx(v,{children:e.jsxs(fe,{className:`py-0 overflow-hidden hover:ring-2 hover:ring-primary transition-all cursor-pointer group ${x?"ring-1 ring-green-500/50":""} ${f?"opacity-70":""}`,children:[e.jsxs("div",{className:"aspect-2/3 bg-muted relative",children:[l.coverUrl?e.jsx("img",{src:l.coverUrl,alt:l.title,className:`w-full h-full object-cover transition-all duration-300 ${f?"grayscale":""}`,loading:"lazy"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(d,{icon:_,className:"h-16 w-16 text-muted-foreground/50"})}),e.jsxs("div",{className:"absolute top-2 right-2",children:[x&&e.jsxs(j,{variant:"default",className:"bg-green-600 text-white",children:[e.jsx(d,{icon:Le,className:"h-3 w-3 mr-1"}),"Downloaded"]}),!x&&l.inLibrary&&l.requested&&e.jsxs(j,{variant:"secondary",className:"bg-yellow-600 text-white",children:[e.jsx(d,{icon:$e,className:"h-3 w-3 mr-1"}),"Requested"]})]}),!x&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity",children:f?e.jsxs(p,{variant:"secondary",size:"sm",className:"gap-1",onClick:D,disabled:c,children:[c?e.jsx(A,{className:"h-4 w-4"}):e.jsx(d,{icon:ae,className:"h-4 w-4"}),"Add to Library"]}):l.libraryId?e.jsx(p,{variant:"secondary",size:"icon",className:"h-12 w-12 rounded-full",onClick:M,disabled:S,children:S?e.jsx(A,{className:"h-6 w-6"}):e.jsx(d,{icon:Pe,className:"h-6 w-6"})}):null})]}),e.jsxs(xe,{className:`p-3 ${f?"opacity-70":""}`,children:[e.jsx("h3",{className:"font-medium truncate group-hover:text-primary transition-colors",children:l.title}),e.jsx("div",{className:"flex items-center justify-between text-sm text-muted-foreground",children:l.seriesName?e.jsxs("span",{className:"truncate",children:[l.seriesName," #",l.seriesPosition]}):e.jsx("span",{children:"Â "})})]})]})})}Me.__docgenInfo={description:"",methods:[],displayName:"AuthorDetail"};export{Me as default};
