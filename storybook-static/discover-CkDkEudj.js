import{j as i}from"./jsx-runtime-u17CrQMm.js";import{f as ke,a4 as Te,a5 as Pe,H as xe,a6 as Ne,a7 as Re,S as Ae,a as Ce,b as Me,c as qe,d as Ee,r as Q,t as l}from"./app-CFoDCqX-.js";import{A as Oe}from"./app-layout-CTvh2ZE0.js";import{B as Fe}from"./button-B9kPMW4q.js";import{S as _e}from"./skeleton-A7behTLO.js";import{S as $e}from"./spinner-McTJFRVv.js";import{H as Le,n as De}from"./index.min-fvaCWwiU.js";import{M as Be}from"./media-teaser-CTZEtwns.js";import{r as a}from"./app-BHuVDAkc.js";import"./preload-helper-PPVm8Dsz.js";import"./client-Bx265bNG.js";import"./index-CYxWbFTv.js";import"./index-D5-0xbEa.js";import"./utils-CDN07tui.js";import"./dialog-CQTA4pg1.js";import"./createLucideIcon-GXN1tXoc.js";import"./badge-B6bn15vN.js";import"./slot-CUYGZ4Fv.js";import"./media-status-badge-DETbNkVM.js";import"./useRenderElement-D0Q1kVud.js";import"./useBaseUiId-BvJSLVy2.js";import"./useValueAsRef-GoV-SdOe.js";import"./check-BEKQ83Eb.js";import"./useLabelableId-CyGgmgle.js";import"./valueToPercent-CmxdyyhM.js";import"./hamster-icon-DOXrnfMg.js";import"./input-Bw95PIWX.js";const Ve={movies:{popular:"Popular Movies",now_playing:"Now in Cinemas",trending:"Trending Movies","trakt-trending":"Trending on Trakt","trakt-anticipated":"Most Anticipated","trakt-recommended":"Community Recommended","justwatch-popular":"Popular Streaming Movies"},tv:{popular:"Popular Shows",on_the_air:"Currently Airing",top_rated:"Top Rated Shows",trending:"Trending Shows","trakt-trending":"Trending on Trakt","trakt-anticipated":"Most Anticipated","trakt-recommended":"Community Recommended","justwatch-popular":"Popular Streaming Shows"}},He={28:"Action",12:"Adventure",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",14:"Fantasy",36:"History",27:"Horror",10402:"Music",9648:"Mystery",10749:"Romance",878:"Sci-Fi",10770:"TV Movie",53:"Thriller",10752:"War",37:"Western"},Ue={10759:"Action",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",10762:"Kids",9648:"Mystery",10763:"News",10764:"Reality",10765:"Sci-Fi",10766:"Soap",10767:"Talk",10768:"Politics",37:"Western"},X={"trakt-trending":"trakt","trakt-anticipated":"trakt","trakt-recommended":"trakt","justwatch-popular":"justwatch"},We={movies:{"trakt-trending":"trakt-trending-movies","trakt-anticipated":"trakt-anticipated-movies","trakt-recommended":"trakt-recommended-movies","justwatch-popular":"justwatch-popular-movies"},tv:{"trakt-trending":"trakt-trending-shows","trakt-anticipated":"trakt-anticipated-shows","trakt-recommended":"trakt-recommended-shows","justwatch-popular":"justwatch-popular-shows"}};function Ge(){const{url:_}=ke(),N=_.split("?")[0].split("/"),$=N.indexOf("discover"),Z=N[$+1]||"movies",p=N[$+2]||"popular",r=Z,L=new URLSearchParams(_.split("?")[1]||""),y=L.get("genreId"),D=L.get("sortBy")||"popularity.desc",f=p==="genre"&&!!y,ee=f?(r==="movies"?He:Ue)[y]||"Genre":"",te=f?`${ee} ${r==="movies"?"Movies":"Shows"}`:"",B=f?te:Ve[r]?.[p]||"Discover",R=p in X,V=r==="movies"?"/api/v1/movies/discover":"/api/v1/tvshows/discover",H=r==="movies"?"/api/v1/recommendations/movies":"/api/v1/recommendations/tv",[U,I]=a.useState([]),[j,A]=a.useState(0),[S,C]=a.useState(1),[g,k]=a.useState(!1),[W,M]=a.useState(!0),[se,q]=a.useState(new Set),[v,oe]=a.useState(D),G=a.useRef(null),[J,re]=a.useState([]),[ae,ie]=a.useState([]),[u,ne]=a.useState(null),[de,w]=a.useState(!1),[le,T]=a.useState(!1),[ce,E]=a.useState(!1),[me,K]=a.useState(null),b=ae.filter(e=>e.mediaType===(r==="movies"?"movies":"tv")),O=[{value:"popularity.desc",label:"Popular"},{value:r==="movies"?"primary_release_date.desc":"first_air_date.desc",label:"Newest"},{value:"vote_average.desc",label:"Top Rated"},...r==="movies"?[{value:"revenue.desc",label:"Revenue"}]:[]];a.useEffect(()=>{Promise.all([fetch("/api/v1/rootfolders").then(e=>e.json()),fetch("/api/v1/qualityprofiles").then(e=>e.json())]).then(([e,t])=>{re(e),ie(t)})},[]);const P=a.useCallback(async e=>{if(!(g||e>S)){k(!0);try{let t=`${V}?category=${p}&page=${e}`;f&&y&&(t+=`&genreId=${y}&sortBy=${v}`);const s=await fetch(t);if(s.ok){const o=await s.json();I(n=>{const m=new Set(n.map(c=>c.tmdbId)),d=o.results.filter(c=>!m.has(c.tmdbId));return[...n,...d]}),C(o.totalPages),A(e)}}catch(t){console.error("Failed to fetch discover page:",t)}finally{k(!1),M(!1)}}},[V,p,g,S,f,y,v]),ue=a.useCallback(async()=>{k(!0);try{const e=X[p],t=We[r]?.[p],s=await fetch(`${H}?source=${e}`);if(s.ok){const n=(await s.json()).lanes?.find(m=>m.key===t);n&&I(n.items),C(1),A(1)}}catch(e){console.error("Failed to fetch recommendations:",e)}finally{k(!1),M(!1)}},[H,p,r]);a.useEffect(()=>{R?ue():P(1)},[]);const pe=e=>{oe(e),I([]),A(0),C(1),M(!0)};a.useEffect(()=>{f&&v!==D&&P(1)},[v]),a.useEffect(()=>{if(R)return;const e=G.current;if(!e)return;const t=new IntersectionObserver(s=>{s[0].isIntersecting&&!g&&j<S&&P(j+1)},{rootMargin:"400px"});return t.observe(e),()=>t.disconnect()},[R,j,S,g,P]);const h=(e,t)=>{I(s=>s.map(o=>o.tmdbId===e?t(o):o))},Y=async(e,t)=>{const s=J.find(o=>o.mediaType==="movies");if(!s){l.error("No root folder configured for movies. Please add one in Settings.");return}T(!0);try{const o=await fetch("/api/v1/movies",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tmdbId:e.tmdbId,title:e.title,year:e.year,qualityProfileId:t,rootFolderId:s.id,requested:!0,searchOnAdd:!0})});if(o.ok){const n=await o.json();l.success(`${e.title} added to library`),w(!1),h(e.tmdbId,m=>({...m,inLibrary:!0,libraryId:n.id,requested:!0}))}else{const n=await o.json();l.error(n.error||"Failed to add movie")}}catch{l.error("Failed to add movie")}finally{T(!1)}},z=async(e,t,s)=>{const o=J.find(n=>n.mediaType==="tv");if(!o){l.error("No root folder configured for TV shows. Please add one in Settings.");return}T(!0);try{const n=await fetch("/api/v1/tvshows",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tmdbId:e.tmdbId,title:e.title,year:e.year,qualityProfileId:t,rootFolderId:o.id,requested:!0,searchOnAdd:!0,selectedSeasons:s?.selectedSeasons,selectedEpisodes:s?.selectedEpisodes})});if(n.ok){const m=await n.json();l.success(`${e.title} added to library`),w(!1),K(null),h(e.tmdbId,d=>({...d,inLibrary:!0,libraryId:m.id,requested:!0}))}else{const m=await n.json();l.error(m.error||"Failed to add TV show")}}catch{l.error("Failed to add TV show")}finally{T(!1)}},fe=e=>{ne(e),r==="tv"?E(!0):b.length===1?Y(e,b[0].id):w(!0)},ve=e=>{K(e),E(!1),b.length===1?z(u,b[0].id,e):w(!0)},ge=e=>{u&&(r==="movies"?Y(u,e):z(u,e,me))},he=async e=>{if(!e.libraryId||!e.inLibrary)return;const t=e.tmdbId;q(d=>new Set(d).add(t));const s=e.requested;if(r==="movies"&&s&&e.hasFile){l.error("Movie has downloaded files. Delete files first before unrequesting."),q(d=>{const c=new Set(d);return c.delete(t),c});return}h(t,d=>({...d,requested:!s}));const o=r==="movies"?`/api/v1/movies/${e.libraryId}/request`:`/api/v1/tvshows/${e.libraryId}`,n=r==="movies"?{requested:!s}:{requested:!s},m=r==="movies"?"POST":"PUT";try{const d=await fetch(o,{method:m,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),c=await d.json();d.ok?c.deleted?(l.success("Removed from library"),h(t,F=>({...F,inLibrary:!1,libraryId:void 0,requested:!1}))):l.success(s?"Unrequested":"Requested"):(h(t,F=>({...F,requested:s})),l.error(c.error||"Failed to update"))}catch{h(t,d=>({...d,requested:s})),l.error("Failed to update")}finally{q(d=>{const c=new Set(d);return c.delete(t),c})}},{openMoviePreview:ye,openTvShowPreview:Se}=Te(),we=e=>{if(e.inLibrary&&e.libraryId){const t=r==="movies"?`/movie/${e.libraryId}`:`/tvshow/${e.libraryId}`;Q.visit(t)}else r==="movies"?ye(e.tmdbId):Se(e.tmdbId)},x=r==="movies",{providers:be,loadingIds:Ie,observerRef:je}=Pe(x?"movie":"tv");return i.jsxs(Oe,{title:B,headerPrefix:i.jsx(Fe,{variant:"ghost",size:"icon",className:"-ml-1",onClick:()=>Q.visit(`/search?mode=${r==="movies"?"movies":"tv"}`),children:i.jsx(Le,{icon:De,className:"h-5 w-5"})}),actions:f?i.jsxs(Ae,{value:v,onValueChange:pe,children:[i.jsx(Ce,{className:"w-[150px] h-9",children:i.jsx(Me,{placeholder:O.find(e=>e.value===v)?.label??"Sort by",children:O.find(e=>e.value===v)?.label??"Sort by"})}),i.jsx(qe,{children:O.map(e=>i.jsx(Ee,{value:e.value,children:e.label},e.value))})]}):void 0,children:[i.jsx(xe,{title:B}),i.jsxs("div",{className:"p-6 space-y-6 max-w-7xl mx-auto",children:[W?i.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:Array.from({length:18}).map((e,t)=>i.jsx(_e,{className:"aspect-[2/3] rounded-lg"},t))}):i.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4",children:U.map(e=>{let t="none";if(e.inLibrary)if(x){const o=e;t=o.hasFile?"downloaded":o.requested?"requested":"downloaded"}else t=e.requested?"requested":"downloaded";const s=t==="none"?()=>fe(e):t==="requested"?()=>he(e):void 0;return i.jsx(Be,{tmdbId:e.tmdbId,title:e.title,year:e.year,posterUrl:e.posterUrl,genres:e.genres,mediaType:x?"movie":"tv",status:t,isToggling:se.has(e.tmdbId),showStatusOnHover:t==="none",onToggleRequest:s,streamingProviders:be[e.tmdbId],isLoadingProviders:Ie.has(e.tmdbId),observerRef:je(e.tmdbId),onClick:()=>we(e)},e.tmdbId)})}),i.jsx("div",{ref:G,className:"h-1"}),g&&!W&&i.jsx("div",{className:"flex justify-center py-4",children:i.jsx($e,{className:"h-6 w-6"})}),!g&&j>=S&&U.length>0&&i.jsx("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No more results"})]}),u&&r==="tv"&&i.jsx(Ne,{tmdbId:u.tmdbId,showTitle:u.title,open:ce,onOpenChange:E,onConfirm:ve}),u&&i.jsx(Re,{open:de,onOpenChange:w,mediaType:x?"movie":"tvshow",title:`Add ${u.title}`,description:`Add ${u.title} to your library`,qualityProfiles:b,adding:le,onAdd:e=>ge(e)})]})}Ge.__docgenInfo={description:"",methods:[],displayName:"DiscoverPage"};export{Ge as default};
